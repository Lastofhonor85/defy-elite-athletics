name: Deploy Defy Elite Athletics Website

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  actions: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies (if any)
        run: |
          if [ -f package.json ]; then
            npm ci
          fi

      - name: üõ°Ô∏è Verify Terms Gate File
        run: |
          FILE="terms-gate.html"
          echo "Checking if $FILE exists and has content..."
          if [ ! -s "$FILE" ]; then
            echo "terms-gate.html is missing or empty ‚Äî restoring default legal version."
            cat > $FILE <<'EOF'
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Terms & Conditions ‚Äì Defy Elite Athletics</title>
  <link rel="stylesheet" href="styles.css?v={{VERSION}}" />
  <style>
    body.dark {
      display:flex; flex-direction:column; justify-content:center; align-items:center;
      min-height:100vh; background:#000; color:#fff; font-family:Arial, sans-serif; padding:2rem;
    }
    .gate-box {
      max-width:820px; background:#111; padding:2rem; border-radius:10px;
      box-shadow:0 0 20px rgba(0,0,0,0.7);
    }
    h1,h2{color:#09f;}
    p,li{color:#ddd; line-height:1.6;}
    .agree-btn{
      background:#09f; color:#fff; border:none; padding:12px 28px;
      border-radius:6px; font-size:1rem; cursor:pointer; margin-top:1.5rem;
      transition:background .3s;
    }
    .agree-btn:hover{background:#0077cc;}
    footer{text-align:center;color:#666;margin-top:2rem;font-size:.9rem;}
  </style>
</head>

<body class="dark">
  <div class="gate-box">
    <header style="text-align:center;margin-bottom:1rem;">
      <img src="assets/logo1.png" alt="Defy Elite Athletics" style="max-width:200px;">
    </header>

    <main>
      <h1>Terms & Conditions</h1>
      <p>
        Welcome to <strong>Defy Elite Athletics</strong>. Please read these Terms carefully before
        using any materials or services provided. By clicking ‚ÄúI Agree,‚Äù you acknowledge that you have
        read, understood, and accept these Terms and our Privacy Policy.
      </p>

      <h2>1. Informational Purpose Only</h2>
      <p>
        All content‚Äîincluding exercise descriptions, videos, and nutrition guidance‚Äîis provided for
        educational purposes only and does not constitute medical advice. Consult a qualified
        healthcare professional before beginning any new exercise or nutrition program.
      </p>

      <h2>2. Assumption of Risk</h2>
      <p>
        You understand that participation in physical activity involves inherent risks, including
        serious injury or death, and you voluntarily assume all such risks.
      </p>

      <h2>3. Release of Liability</h2>
      <p>
        You hereby release, discharge, and hold harmless Defy Elite Athletics, its owners, employees,
        contractors, and affiliates from any and all claims, demands, or causes of action arising out
        of your participation or reliance on site materials, to the fullest extent permitted by law.
      </p>

      <h2>4. No Warranty</h2>
      <p>
        The website and its materials are provided ‚Äúas is‚Äù without warranties of any kind, express or
        implied, including but not limited to fitness for a particular purpose or guaranteed results.
      </p>

      <h2>5. Governing Law</h2>
      <p>
        These Terms shall be governed by and construed in accordance with the laws of the State of
        <strong>New Mexico, USA</strong>, without regard to its conflict-of-law principles. Any disputes
        arising out of or relating to these Terms shall be brought exclusively in the state or federal
        courts located in New Mexico, and you consent to the jurisdiction of those courts.
      </p>

      <h2>6. Acknowledgment of Agreement</h2>
      <p>
        By clicking ‚ÄúI Agree & Enter Site,‚Äù you affirm that you are of legal age and fully understand
        and voluntarily accept these terms. This release is binding upon you and your heirs,
        successors, and assigns.
      </p>

      <div style="text-align:center;">
        <button class="agree-btn" onclick="acceptTerms()">I Agree & Enter Site</button>
      </div>
    </main>

    <footer>¬© 2025 Defy Elite Athletics | All Rights Reserved</footer>
  </div>

  <script>
    function acceptTerms(){
      localStorage.setItem('defyAgreedToTerms','true');
      window.location.href='home.html?v={{VERSION}}';
    }
    if(localStorage.getItem('defyAgreedToTerms')==='true'){
      window.location.replace('home.html?v={{VERSION}}');
    }
  </script>
</body>
</html>
EOF
          else
            echo "‚úÖ terms-gate.html verified and present."
          fi

      - name: üîÑ Update Cache Version
        run: |
          VERSION=$(date +%s)
          echo "Cache version: $VERSION" > cache-version.txt
          # Replace {{VERSION}} placeholders in Terms Gate (for cache-busting)
          sed -i "s/{{VERSION}}/$VERSION/g" terms-gate.html
          echo "Cache version injected into HTML."

      - name: Commit and Push Updates
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          git config user.name "Defy-AutoDeploy"
          git config user.email "actions@github.com"
          git add .
          git commit -m "Auto-deploy with cache-busting version [skip ci]" || echo "No changes to commit"
          git push https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }} HEAD:main
